nextflow.enable.dsl=2

data = channel.fromPath(params.homer_input_csv)
		.splitCsv(header: True)
		.map { sample -> [sample.grouping, sample.name, file(sample.regions)]}

process HOMER_ENRICHMENT {

	label 'process_medium'
	publishDir "${params.outdir}/${grouping}_${name}", mode: 'copy'
    	container '/storage/data/MAP/hpcapps/opt/core/pipelines/ingm-base.0.5.2.simg'

	input:
	tuple val(grouping), val(name), path(regions)

	output:
	tuple val(grouping), val(name), file("*.html")
	file "homerResults/*" 
	file "knownResults/*" 

	script:
	"""
	set +eu    
	source activate ${HOME}/singularity/envs/motifanalysis/   
	${HOME}/singularity/envs/motifanalysis/bin/findMotifsGenome.pl ${regions} hg38 ./ -size given -p ${task.cpus}
	mv *knownResults.txt ${name}_knownResults.txt
	"""
}


/*
data_for_diff = data.groupTuple(by: 0)


process DIFF_ENRICHMENT_ONE_WAY {

	label 'process_medium'
	publishDir "${params.outdir}/${grouping}_${name[0]}_vs_${name[1]}_as_bg", mode: 'copy'
    	container '/storage/data/MAP/hpcapps/opt/core/pipelines/ingm-base.0.5.2.simg'

	input:
	tuple val(grouping), val(name), path(regions)

	output:
	tuple val(grouping), val(name), path(*.html)
	file "homerResults/*"
	file "knownResults/*"

	script:
	"""
	set +eu
	source activate ${HOME}/singularity/envs/motifanalysis/
	${HOME}/singularity/envs/motifanalysis/bin/findMotifsGenome.pl ${regions[0]} hg38 ./ -size given -p ${task.cpus} -h -cpg -bg ${regions[1]}
	mv *Results.txt ${name[0]}_vs_${name[1]}_as_bg_results.txt
	"""
}

process DIFF_ENRICHMENT_OTHER_WAY {

	label 'process_medium'
	publishDir "${params.outdir}/${grouping}_${name[1]}_vs_${name[0]}_as_bg", mode: 'copy'
    	container '/storage/data/MAP/hpcapps/opt/core/pipelines/ingm-base.0.5.2.simg'

	input:
	tuple val(grouping), val(name), path(regions)

	output:
	tuple val(grouping), val(name), path(*.html)
	file "homerResults/*"
	file "knownResults/*"
	tuple val(grouping), val(name), path(*.txt)

	script:
	"""
	set +eu
	source activate ${HOME}/singularity/envs/motifanalysis/
	${HOME}/singularity/envs/motifanalysis/bin/findMotifsGenome.pl ${regions[1]} hg38 ./ -size given -p ${task.cpus} -h -cpg -bg ${regions[0]}
	mv *Results.txt ${name[1]}_vs_${name[0]}_as_bg_results.txt
	"""
}

process PLOT_ENRICHMENT {

	label 'process low'
	publishDir "${params.outdir}/plots"
	container '/storage/data/MAP/hpcapps/opt/core/pipelines/ingm-base.0.5.2.simg'

	input:
	tuple val(grouping), val(name), path(results)

	output:
	file "*.pdf"

	script:
	"""
	Rscript plot_motifs.R ${results}
	"""

}

process PLOT_DIFF_ENRICHMENT {

	label 'process low'
	publishDir "${params.outdir}/plots"
	container '/storage/data/MAP/hpcapps/opt/core/pipelines/ingm-base.0.5.2.simg'

	input:
	tuple val(grouping), val(name), path(results_combined)

	output:
	file "*.pdf"

	script:
	"""
	Rscript plot_motifs.R ${results_combined[0]} ${results_combined[1]}
	"""
	
}

*/

workflow {

	 HOMER_ENRICHMENT(data)	 

}