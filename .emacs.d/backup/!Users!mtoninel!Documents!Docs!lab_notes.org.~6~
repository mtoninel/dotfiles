#+title:                                                                                           The Lab Notes File
* Lab Meetings
** 19/10/21 Roberta, Giulia and Jacopo - Epigenetic Rewiring
  Identification of cell-state specific enhancer hubs with a catalitically dead CRISPR-based screening targeting.

  What is a CRISPR-screening??
  - *Arrayed screening*
  - *pooled screening*
    Large culture with library perturbation, synthesizing plasmids and package into lentiviral vectors used to infect cells. The reradout in the most basic way is measured as an enrichment or depletion of specific guides assessed by NGS.
  - *Perturb-seq*
    This allows to recover via sc seq the actual guide which is perturbing the cell and therefore link single perturbation to the actual phenotype. In this case we use more guides ~5 per target to increase the chance of successful KO, while also increasing the chances of off-target effects.
    the repressor initially selected uses two epigenomic regulators which are KRAB and MeCP2.

    Results: CRISPR-off system works very well as opposed to the KRAB-MecP2 system

    To ensure a stable expression of the repressor they are using a knock-in model (Xential) with the Diphteria toxin sensibility construct, cell in which the repressor has integrated will be therefore resistant to the toxin treatment for selection, which is a safer method that does not imply a fluorescent marker. This constructs were delivered using lipofectamine transfection.

    The most variable part of the project might be the design and delivery of a guide library, and this is achieved by different method called CROP-seq.
** 02/11/21 Lorenzo, Jacopo and Marco - Metabolism in Breast Cancer
Concept: decrease the resistance of tumor cells to the stressors induced by a reduced metabolic signalling, since this regime is thought to reduce growth factor signalling. The project uses chemo-naive tumors to understand what are the effects of caloric restrictions on tumor growth and also what are the effects on the microenvironment and especially on immune cells. The specific regime is called Fast-Mimicking Diet (FMD) composed of receiveng a specific amount of calories for 5 days followed by 8 days of refeeding after which the tumor is resected. Libraries are matched within patients (pre-post starvation).
*** Epithelial cells
Statistical approach based on the _representation of single cell types within a sample_ by calculating the likelyhood of detecting n cells of a specific celltype when the biospy cells occupy a specific percentage over the total number of cells within a sample. This is able to statistically assess the overrepresetation of specific celltypes between the surgical resection and the biopsy (i.e. are fibroblasts statistically more represented in a biopsy as opposed to the resection - this is a simplification of the idea behind milo). One of the functional scores used is the conventional and non cGAS/STING pathway and ying/yang score which captures the ying signature which was upregulated in metastatic cells vs normal epithelial cells. To examine cell potency, SCENT was used, while an autoencoder was used to estimate malignancy by analyzing the distance from the input and the output. Then inferCNV was used to understand clonality in the genomic profiles of clusters and determine malignancy of epithelial cells.
*** T-cells
The metabolic aspects related to T-cells are centered on the fact that lactate comprises one of the main metabolic elements influencing Treg cells within the tumor microenvironment. T-cells where selected by taking all cells 2 mad distance more than the median value of the t-cell score distribution. Automatic annotation process with GARNETT since annotation relying on clustering was not satisfying. _A lack of cells with an exhausted phenotype might as well be due to the relatively young age of the tumor which did not have time to develop an exhausted enough TME_. To perform differential analysis, MUSCAT was used. Unfortunately, low number of degs was returned so appaently there is a very low effect from starvation. But this is from an "aggregate" analysis, so that might be rescued by analysing a single sample at a time. 
** 16/11/21 Stefano, Grazisa - lncFOXP3 in regulatory T-cells
The question: do lncRNA, and specifically lncFOXP3, determine T-reg cell identity? IN 2015 Ranzani et al. showed that lncFOXP3 is highly specific for Treg cells. lncFOXP3 appears to be also more specific than FOXP3 itself for treg cells.
* Thesis Project
** TODO Differential analysis with CD4 conventional and Tr1
Sorting: Tr1 CD3+ CD4+ CD27+ CD195+
Sorting: Conventional CD3+ CD4+ CD45RO+ this last one is a marker for memory-like phenotype, whilst CD45RA+ is for naive cells, this means that there are no naive here.
Use CD4 conventional samples which are fully paired but all from NSCLC and mainly consider the ones from PB since the ones from K are composed by about 15% of Tr1.
The CD4 conventional dataset is composed of 9 samples from 3 different subject (n187 supposedly a female but multiqc reports many Ychr reads), patient 180 is a female and patient 169 is a male. Overall they show good quality with lack of any noticeable outliers, 2711 (NAT 187) looks particularly good.
When combining the Tr1 and Conventional datasets we obtain a dds with 21 samples and a final number of intervals corresponding to 93014.
By applying a design formula like ~subject+condition~  the program breaks due to matrix not being full ranked, since subject ids are found in two conditions at once so batch correction cannot be modeled. This happens of course because every subject, for example 181, has three different conditions and therefore for all the dataset, each condition has been paired with one different subject id, so the two are one the linear combination of the other, thing that did not happen with the CD8s due to the fact that both memory and exhausted samples came from the same subject (most of the time). Inititial run done with a ~condition~ design, and then sva correction.
Trying with a dds containing only Tr1 K samples and CD4 Conventional samples from PB with a design ~~cell~. Number of final intervals: 74712 with median peak length of 947 bp, UP 15205 and DOWN 11226 between CD4 Tr1 K and CD4 Conv PB.
- DONE intersection of intervals with  information coming from Tr1 signatures (Bonnal et al. and Gruarin et al.)
  - DONE intersect exhaustion signature intervals with up intervals in Tr1 vs Conv. 246 intervals were identified as overlapping.
    -TODO check for the overlaps (venn) between the differentials identified in this analysis and the ones identified in the previous Tr1 analysis (the tissue one).
    - TODO compare CD4 conv N with the Tr1 from K (??)
** TODO Start writing methods
In order to avoid reviewing through version control, people suggested [[https://tex.stackexchange.com/questions/4489/what-is-a-good-strategy-for-obtaining-comments-on-a-latex-document-from-non-latex][here]] to use [[http://www.crocodoc.com/][this site (doesn't work)]] which lets upload PDFs that can then be commented.
Add references for the Brabraham institute tools such as FastQC and cutadapt which do not have paper associated to them, to cite, use the tool author, year of the first release version and the site.
** Correlation of expression data with accessibility data
*** CD8+
Aim: correlate the expression of genes gathered through scRNA-seq with accessibility data. Comparisons of interest: intervals binning between CD8 texh K and Tmemk (dysfunction signature) and also CD4 Tr1 K vs conventional PB (!!!! watch out when extracting conventional from rna seq to avoid including naive cells since those are actually missing from the  ATAC seq conventional dataset !!!!). Lorenzo suggested to have an avg of atac-seq counts for each gene by considering the within-gene and a upstream and downstream windows and then counting the avg so that we can have a one-to-one correlation of rnaseq counts and atacseq counts.
Results from scRNA are in my home folder under the folder scrna_cd8_exhausted.
For CD8 exhausted, the count matrix was extracted  by isolating the two CD3 sorted samples from fight cancer, one (2514) from NSCLC  and one (2597) from CRC. Sample 2597 contributed very little to the final number of exhausted cells identified (674) within the two datasets. The matrix for the 674 cells was exported, and pseudo-bulk expression distribution were created on the procedural bases already used by Seurat's AverageExpression() function, which takes either non-normalized counts and normalizes them before averaging, or takes log normalized counts and then exponentiates them to exit log-space prior to averaging. Also 1585 memory cells were identified within the two datasets. In orer to gain a better resolution, only cells with CD8 expression > 0 were retained and cells expressing CD4 were excluded prior to clustering.
Once extracted, pseudo-bulk profiles for exhausted and memory were compared to counts coming from intervals of the results from the TexhK vs TmemK analysis at first. Of the 13025 genes in the pseudobulk, 10223 (78.48%) were represented in the intervals, and a total of 27331 (60.99% of the final_interval_table)  intervals were annotated to these genes. 282 intervals out of 517 (54.54%) of the signature were annotated to 236 genes present in the set (out of 10223 - 2.31%). While for the intervals differentially accessible in memory, 565 out of 951 (59.41%) differential intervals were annotated to 447 genes present in the table (out of 10223 - 4.37%). In total,  out of the 27331 intervals annotated to genes present in the expression table, a total of 847 were also differential (3.09%), either up or down between Texh K and TmemK. 
*** CD4+
For the CD4 datasets, initially I took the three K samples from the 5p libraries of fight cancer,  samples 2365, 2508 and 2511. Two were from NSCLC and one from CRC. Data integration was performed using harmony, but can we eventually integrate also samples from N and PB in the same analysis?
scRNA-seq analysis of the three samples returned 8389 "Conventional" T-cells, containing everything apart from Tregs, Tr1 and Tnaive cells. Tr1 cells were 665 while Tregs were 1773. The contribution of the three patients to the clusters was relatively equal. Treg cells were 640 (36.09%) for patient 2365, 507 (28.59%) for patient 2508 and 626 (35,31%) for patient 2511. For the Tr1 cluster, the cells coming from the patients (in the same order as tregs) were 265, 203 and 197.  For the conventional cells, 4480 came from 2365, 2233 from 2508 and 1676 from 2511.
The idea now  would be to generate a single pseudo-bulk profile for each replicate, in order to have a profile for each  patient which can then be used to perform differential analysis between conditions, in this case the conditions being Tr1 within the tumor and Tconv in the peripheral blood (to be analyzed, matching samples 2509, 2363 and 2506). The pseudo-bulk profiles for the aggregated samples are within the ~/analysis/5p_CD4_aggregate_analysis directory. Of the intervals of the Tr1 vs Tconv comparison, 42209 out of 74712 (56.49%) intervals were annotated to genes present in the RNA pseudo-bulk profiles, and vice versa 10614 out of 13231 (80.22%) genes were represented annotated to intervals. When inspecting the differential intervals, 15821 out of the total 26431 up and down intervals (59.86%) had an expressed gene annotated to them, with these genes being a total of 8054 out of the 13231 total genes (60.87%).
Also, isolation of expression profiles for CD4 conventional from PB has to happen, for this approach, we might want to aggregate PB and K samples within one analysis to ensure proper cross-cell normalization and avoid confounding effects downstream.
**  What has been done so far
1. CD8+ ATAC-seq dataset quality control and differential analysis, isolation of a signature of 517 intervals highly accessible in Texh cells in K.
2. CD8+ Footprinting with TOBIAS highlighted a cluster of TFs with a higher activity in CD8 exhausted cells.
3. CD4+ Tr1 and Conventional quality control and differential analysis. In particular with a focus on the comparison Tr1 K vs Conventional PB to highlight possible differences related to a change in cell state rather than celltype. These intervals where then compared with the dysfunctional signature and about 50% of the signature intervals are overlapping with intervals up-regulated in Tr1K compared to conventional PB.
4. CD4+ Tr1 footprinting analysis with TOBIAS (possibility to include CD4 conventional PB in the analysis to look at differential binding, this is to be discussed).
5. scATAC-seq analysis of public data (Satpathy et al. - 2019) to confirm the presence of the exhaustion signature in a sc dataset of pre-PD1 therapy in BCC. (Of course, the use of this dataset just to identify an overlap of intervals is reductive, there are many other interesting insights coming from the exhausted cluster, also involving transcription factor activity with ChromVAR and motif enrichment).
6. Extraction of pseudo-bulk RNA-seq profiles for Texh and Tmem identified within the CD3+ scRNA-seq datasets from the fight cancer libraries.
7. Correlation of the accessibility signal with RNA expression for CD8+ cells, unfortunately without the possibility of generating additional replicate-based pseudo-bulk due to the very low contribution of exhausted cells from one of the two samples. Indeed, genes associated with intervals more accessible in CD8 exhausted cells have, on average, a higher expression level than in memory cells within the tumor.
** TODO What is there to do?
1. Also correlate RNA-seq and ATAC-seq for CD4 cells. Since many libraries are CD4+ sorted, we can take a more quantitative approach by generating a pseudo-bulk profile for each subject and then treating these as single samples in a pseudo-bulk differential expression analysis, which can be useful in correlating a more relative measure such as log2FC between ATAC and RNA, as opposed to straight counts, which might be more confounding and more biased. This approach can also give an idea of how much each library contributes to the cell pool for any given specific celltype.
2. Identify Tr1s within the scATAC seq dataset (might restrict the search to only CD4+ cells)
3. Do hichip data for CD4 conventional exist? look at punctual information for Tr1s, what's the accessibility in specific loci for example IL-10 or granzyme K or PD1??

* Various Issues
** DONE Magit issue
magit not working in univa-comp since version required by magit  >= 2.2 and univa has 1.8.3, try to see if tramp is using the wrong git exec on univa if multiple versions are installed. check value of magit-remote-git-executable. (should try and download a different magit version compatible with git 1.8.3)
cannot install mactex due to lacking admin privileges.
** TODO  NOTEBOOK FOR TOBIAS
- [X ] Join notebook with overview file manipulation
- [ ] How many double motifs for a single tf in one peak (duplicates) are there? 26% of motifs are duplicated in Tr1 while for CD8 the value is 20%. 
- [X ]Implement a method for concatenating files within a notebook and then also do the intersection between bed of interest and TOBIAS consensus
- [ ] Implement a way to see accessible motifs based on a gene list (questionable)
- [X ]looping over all the different scores, each column to define then a single heatmap for each condition... needed?
- Add buffer on axes to volcano to avoid cluttering at edges
** TODO Standardize a diff analysis notebook with Carolina
Sections to include in the standard notebook: 
** TODO Clear space on HPC by removing all the obsolete analyses
* TOBIAS Footprinting Questions
** Open  Questions
We have defined the way in which tobias calculates binding scores (considering depletion + accessibility).
But still have to define how the global distribution of binding score is defined and how is the universal binding threshold obtained?? Just one value, not one for each condition of interest. 

Issue Format TOBIAS:

Hello Mette,

Thanks for this amazing tool! I have a couple of questions regarding BINDetect which came up while I was reading the supplementary informations of the TOBIAS paper.
In the first place, I understood the way the footprint score is calculated for each position along the genome (position that is referred to as "i" in the supplementary equations, which I'm guessing is each single base), but I'm struggling to understand how then we end up with a single footprint score for each binding site (i.e. TFBS) which is composed by multiple bases. In other words, how does the 'matching' between the footprint scores and the binding site take place? What is the operation performed across the different single-position scores?

Secondly, I was wondering how is the global bound/unbound threshold calculated?
In other words, when the BINDetect section of the supplementary says:
"In the second step of the algorithm, every TF binding site found (for each motif given as input) is split into bound and unbound sites based on a score threshold per condition. The threshold is set at the level of significance of a normal-distribution fit to the background distribution of scores (user-defined p-value)."
How can a single background distribution of scores be built starting from the different score distributions of the single conditions if this is really the case?

Thanks,

Mattia
** TODO Include the information regarding the number of binding sites into the analysis
Thinking about doing a similar thing to what lorenzo has done for the scRNAseq by statistically measure if the number of binding sites is more than what is expected by chance in one condition or the other for every transcription factor, that might be helpful. The same aspect that he has done for the number of cells in each cluster between the two conditions. 
** TODO Fix footprinting including TOX pwm
In order to include TOX pwm, which is apparently non-existing, might have to build it using gimmeMotifs and data from [[https://www.embopress.org/doi/full/10.15252/embj.201490061][this paper]] which talks about DamID motif definition for tox and provides some material to rebuild the pwm. Info about gimmeMotifs [[https://gimmemotifs.readthedocs.io/en/stable/][here]].
** TODO Include the option of filtering with RNA-seq data
The option is implemented at the beginning of the notebook with the use of a package to match ensembl IDs from the RNA-seq table to the gene names of theTOBIAS table. When using this, out of the 633 TF names output by tobias, 552 were present within the RNA-seq dataset (bulk Treg just for testing) after the matching with the converted ensembl gene ids within the RNA-seq table, the 81 left were all TF variants or dimers. 
If we import a dds we can take advantage also of the information regarding the sample metadata to select samples properly.
* Webinars
** Luca Giorgetti - Genome 3D organization
Hi-c data viz with Higlass browser. TAD can be defined as continuous regions in the genome with high intensity of interaction and show a nice clear boundary, inside TADs we can clearly distinguish defined dots named 'loops' and also a higher complexity level of interaction defined by 'stripes'. A and B domains are highly variable during differentiation whereas TADs remain relatively fixed. There are 0 examples of an enhancer which lies outside of the boundaries of the promoter that it regulates. Cohesin and opposite CTCF sites allow for packing chromatin, but also acetylated cohesin is involved in keeping together sister chromatids during mitotic interphase. Getting rid of cohesin (Rad21) basically erases all chromatin conformation structures, whereas acute lack of CTCF get rid of loops but still some structure remain, which are specific and don't need the protein to form boundaries. Transcriptional levels are determined by distance as long as a regulatory element is within the same TAD as the promoter of the gene that it regulates, since TADs act as hard transcriptional barriers. By reducing the number of CTCF sites at boundaries we can reduce the strength of the boundary and expose specific genes to the effect of nearby regulatory regions (Anania et al., BiorXiv, 2021). Also, eQTLs with measurable effects are enriched within CTCF loops, meaning that the non-coding regulation of genes is intimately connected to the structural aspects of chromatin. Transcriptional levels scale with contact frequence, altough decaying at a slower rate, so this also allows long range interactions to be effective even if those regulatory regions are very far away, and this then of course decays in a larger way after a higher distance up until transcription is completely insulated by the boundary. So enhancer activity appears to be dependent on three main things: strength of the enhancer itself, presence of CTCF sites and distance wihin the same TAD. All these three variables of course intervene in the contact strength and time between promoters and regulatory regions, allowing a kind of  "gear switching" in transcription.
** Peter Lewis - The polycomb repressive complex in chromatin organization
Polycomb has two main forms PRC1 and PRC2, one is a writer for Ac3me and the second one a reader. PCL proteins make up altogether with EZH1/2 makes up part of the complex. EZH2 includes its own catalytic site and also another protein known as EED, altogether to SUZ12. Dysregulation of K27me3 is found in many types of cancer, and PRC2 seems to be acting as a pro-tumor driver, with it and lack of demethylation comes an increase risk of cancer development, especially glioma/glioblastoma and T-ALL. Moreover, K-to-M mutations in histone H3 (oncohistones) are associated to tumor, since they transform histones into potent inhibitors of lysine demethylases. H3 K27M makes up only about 3-17% of the total amount of H3 in tumor cells, and the mutation is the earliest detectable mutation in the mutation spectrum of pediatric gliomas. Methionine is thought to interact with the catalytic site of PRC2 inhibiting further action.  Many childhood tumors have a lower mutational burden as opposed to adult tumors (less time to develop a mature mutational profile??).  This makes us believe that during differentiation, cells are blocked in a transient highly dividing step which allows for a big-hit to happen and provoke a full tumoral phenotype, and this bug hit is K27M, which  allows for a highly proliferative capacity and synergizes with  other oncogene mutations like loss of p53 in pediatric glioma.  So can we detoxify K27M?? It has been found that all other histone modifications around H3K27 are inhibitors of methylation, therefore by putting additional modifications before methylation happens might inhibit PRC2 to getting to H3 at all, and so it worked for poly-Ac deposition via HDAC inhibitor treatment. EZHIP in ependymomas (pediatric brain tumor type) is the first characterized K27M oncohistone mimic. PFA ependymomas express high levels of EZHIP and its expression is associated with poor prognosis.
** Smita Krishnaswamy - ML and Data visualization
Goals: denoise, distill structure, analysing the dynamics of data from snapshots in which data are usually captured. Data graphs are used to unsupervisely learn and interpret data. Computational homology is the computing correspondant of topology, but it is not enough for biological data, therefore a filtration using geometry was used via condensation, it applies a low-pass filter bringing data together and recomputing data together. Their method is called MultiscalePHATE.
** Davide Cittaro - Deep Learning paradigms to integrate multimodal single-cell data
multiomic: taking different views from multiple subsampled cell populations vs multimodal: different aspects of the same cell. When it comes to data integration we can have "horizontal" integration and "vertical" integration, the latter being the most important, with more modalities coming from single cells and also the most challenging one, the "diagonal" integration which is the sum of the two, the first across samples and the second across modalities. To integrate data, they use coupled GANs, or generative adversarial networks.  
** MLCB2021 - Day 1
Initial talk by David Kelley on "Enforcer" for motifs (Effective gene expression prediction from sequence by intergrating long-range interactions - Nat. Met. and predicting 3D genome architecture with Akita)
*** scBasset - analysis tool for scATAC-seq data implementing sequence-based convolutional neural networks to model accessibility data
Current state of the art on atac modelling include cistopic and scale, which rely their prediction on peak co-occurrence, threfore ignoring sequence information. scBasset on the other hand uses sequence info to convolve layers in a basset model (kelly et al.), this allows for the creation of a Leiden peak embedding which can be used for clustering and imputation, but also tf activity inference with a known motif. Performs better than chromVAR motifs. By using motif injection, by which a background sequecne with no motif in the center is compared using a trained model to a sequence with a motif in the center. The activity inference appears to be more performant than chromVAR.  The tool is also able to infer motif activity at a per-cell and a per-nucleotide resolution by using in silico saturation mutagenesis (ISM).
*** scDoRI - single cell multi omic regulatory inference
Topic modelling based generative approach with softmax function to model multiome data, with coupled scATAC and scRNA data within single cells. The system is based on an  encoder taking two matrices as input, one is genes x cell matrix and one is cell x topic matrix, and a sequence based convolutional neural network is then able to learn and generate a peak embedding for each topic. The sotware tries to learn gene expression by looking at co-accessible motifs with the gene. The topics identified by the method can be interpreted by looking at gene modules associated to the topic, which can be used for GSEA, then peak modules associated to topics which can be used to find enrichment of TFs. Finally also TF motif activity can be assessed within topics. In the end, the model output is formed of matrix products of matrices learned by CNNs starting from the multiome data. 
*** scOrigami: Prediction of 3D chromatin structure and cis-regulatory interaction networks from single-cell chromatin accessibility data
